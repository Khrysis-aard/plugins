<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, December 21, 2024, 12:21 AM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "Atk_Aoe_Manager" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Atk_Aoe_Manager"
   author="Khrysis"
   id="689c1286fe55ac130d90458c"
   language="Lua"
   purpose="Manage Your Atk and Aoe spells"
   save_state="y"
   date_written="2024-12-21 00:10:03"
   requires="5.07"
   version="1.51"
   >
<description trim="y">
<![CDATA[
============================================================================
                     ATK AOE MANAGER CHANGE LOG
============================================================================
v1.510
- New [AAM STATUS]: Refined UI showing active spells and database counts.
- New [AAM LIST]: Redesigned grid-view for easier reading of spell lists.
- Added Skill Support: Separate category for non-spell combat skills.
- Added Short Syntax: Map long skill names to short commands via 'setskill'.
- Auto-Upgrade Logic: Automatically detects Expert/95% mastery to update 
  active attack variables.

* Type 'aam help' for full command documentation.
============================================================================
]]>
</description>

</plugin>

<!--  Triggers  -->

<triggers>
<!-- Combined Trigger for Expert-level AoE and Attack spells -->
<trigger
   enabled="y"
   group="set spell on tier or R1"
   match="^You are now an expert in (.*)\.$"
   regexp="y"
   expand_variables="y"
   send_to="12"
   sequence="100"
  >
    <send>
      -- Get the spell/skill name
      local spell = "%1"
      local found = false
      local spellCategory = nil  -- Track the category (Patk, Aoe, or Skill)

      -- Check Patk first
      for _, v in ipairs(Patk) do
        if string.lower(v) == string.lower(spell) then
          spellCategory = "atk"
          found = true
          break
        end
      end

      -- If not found in Patk, check Aoe
      if not found then
        for _, v in ipairs(Aoe) do
          if string.lower(v) == string.lower(spell) then
            spellCategory = "aoe"
            found = true
            break
          end
        end
      end

      -- If not found in Aoe, check Skills
      if not found then
        for _, v in ipairs(Skills) do
          if string.lower(v) == string.lower(spell) then
            spellCategory = "skill"
            found = true
            break
          end
        end
      end

      -- If the spell/skill is found, update the appropriate variable
      if found then
        if spellCategory == "atk" then
          local currentSpell = GetVariable("atkspell")
          if string.lower(currentSpell) ~= string.lower(spell) then
            SetVariable("atkspell", spell)
            Note("Attack spell is now: " .. spell)
          end
        elseif spellCategory == "aoe" then
          local currentSpell = GetVariable("aoespell")
          if string.lower(currentSpell) ~= string.lower(spell) then
            SetVariable("aoespell", spell)
            Note("AoE spell is now: " .. spell)
          end
        elseif spellCategory == "skill" then
          local currentSkill = GetVariable("skill")
          if string.lower(currentSkill) ~= string.lower(spell) then
            SetVariable("skill", spell)
            Note("Skill is now: " .. spell)
          end
        end
      end
    </send>
  </trigger>

<!-- Combined Trigger for 95% match AoE and Attack spells -->
<trigger
   enabled="y"
   group="set spell (95%)"
   match="^(Spell|Skill) (.*)\. \((95|85)\%\)$"
   regexp="y"
   expand_variables="y"
   send_to="12"
   sequence="100"
  >
    <send>
      -- Get the spell/skill name
      local spell = "%2"
      local found = false
      local spellCategory = nil  -- Track the category (Patk, Aoe, or Skill)

      -- Check Patk first
      for _, v in ipairs(Patk) do
        if string.lower(v) == string.lower(spell) then
          spellCategory = "atk"
          found = true
          break
        end
      end

      -- If not found in Patk, check Aoe
      if not found then
        for _, v in ipairs(Aoe) do
          if string.lower(v) == string.lower(spell) then
            spellCategory = "aoe"
            found = true
            break
          end
        end
      end

      -- If not found in Aoe, check Skills
      if not found then
        for _, v in ipairs(Skills) do
          if string.lower(v) == string.lower(spell) then
            spellCategory = "skill"
            found = true
            break
          end
        end
      end

      -- If the spell/skill is found, update the appropriate variable
      if found then
        if spellCategory == "atk" then
          local currentSpell = GetVariable("atkspell")
          if string.lower(currentSpell) ~= string.lower(spell) then
            SetVariable("atkspell", spell)
            Note("Attack spell is now: " .. spell)
          end
        elseif spellCategory == "aoe" then
          local currentSpell = GetVariable("aoespell")
          if string.lower(currentSpell) ~= string.lower(spell) then
            SetVariable("aoespell", spell)
            Note("AoE spell is now: " .. spell)
          end
        elseif spellCategory == "skill" then
          local currentSkill = GetVariable("skill")
          if string.lower(currentSkill) ~= string.lower(spell) then
            SetVariable("skill", spell)
            Note("Skill is now: " .. spell)
          end
        end
      end
    </send>
  </trigger>



</triggers>

<!-- Aliases -->
<aliases>
   <alias 
  match="^aam update check$" 
  enabled="y" 
  script="update_check_alias" 
  sequence="99"
  regexp="y"
  >
  </alias>
  
  <alias 
  match="^aam update install$" 
  enabled="y" 
  script="update_install_alias" 
  sequence="99"
  regexp="y"
  >
  </alias>
  <!-- Add primary attack spell -->
  <alias
   match="^aam add patk (.*)$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   expand_variables="y"
   regexp="y"
  >
    <send>local spell = "%1"
      -- Add spell to the Patk table (case-insensitive check for existing spell)
      local found = false
      for _, v in ipairs(Patk) do
        if string.lower(v) == string.lower(spell) then
          found = true
          break
        end
      end
      if not found then
        table.insert(Patk, spell)
        Note("Added primary attack spell: " .. spell)
      else
        Note("Spell already exists in the primary attack spells list.")
      end
    </send>
  </alias>

  <!-- Remove primary attack spell -->
  <alias
   match="^aam rem patk (.*)$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   expand_variables="y"
   regexp="y"
  >
    <send>
      local spell = "%1"
      -- Find the index of the spell in the Patk table (case-insensitive)
      local index = nil
      for i, v in ipairs(Patk) do
        if string.lower(v) == string.lower(spell) then
          index = i
          break
        end
      end
      -- Remove spell if found
      if index then
        table.remove(Patk, index)
        Note("Removed primary attack spell: " .. spell)
      else
        Note("Spell not found in the primary attack spells.")
      end
    </send>
  </alias>

  <!-- Add AoE spell -->
  <alias
   match="^aam add aoe (.*)$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   expand_variables="y"
   regexp="y"
  >
    <send>local spell = "%1"
      -- Add spell to the Aoe table (case-insensitive check for existing spell)
      local found = false
      for _, v in ipairs(Aoe) do
        if string.lower(v) == string.lower(spell) then
          found = true
          break
        end
      end
      if not found then
        table.insert(Aoe, spell)
        Note("Added AoE spell: " .. spell)
      else
        Note("Spell already exists in the AoE spells list.")
      end
    </send>
  </alias>

  <!-- Remove AoE spell -->
  <alias
   match="^aam rem aoe (.*)$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   expand_variables="y"
   regexp="y"
  >
    <send>
      local spell = "%1"
      -- Find the index of the spell in the Aoe table (case-insensitive)
      local index = nil
      for i, v in ipairs(Aoe) do
        if string.lower(v) == string.lower(spell) then
          index = i
          break
        end
      end
      -- Remove spell if found
      if index then
        table.remove(Aoe, index)
        Note("Removed AoE spell: " .. spell)
      else
        Note("Spell not found in the AoE spells.")
      end
    </send>
  </alias>

  <!-- List Primary Attack Spells, AoE Spells, Skills or All -->
  <alias
  match="^aam list (all|patk|aoe|skill|shortsyntax)$"
  enabled="y"
  group="attack"
  send_to="12"
  sequence="100"
  regexp="y"
>
  <send>ShowList("%1")</send>
  </alias>

  <!-- Show Help -->
  <alias
   script="OnHelp"
   match="^aam help$"
   enabled="y"
   regexp="y"
  >
  </alias>

  <!-- Cast Attack Spell -->
  <alias
   match="^aam atk$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   regexp="y"
  >
    <send>-- Get variable
	atkspell = GetVariable("atkspell")
      -- Cast the attack spell
      if atkspell then
        Send("c '".. atkspell .."'")
        Note("Casting attack spell: " .. atkspell)
      else
        Note("No primary attack spell selected.")
      end
    </send>
  </alias>
   <alias
   match="^aam atk (.*)$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   regexp="y"
  >
    <send>-- Get variable
	atkspell = GetVariable("atkspell")
	local mobname = "%1"
      -- Cast the attack spell
      if atkspell then
        Send("c '".. atkspell .."' ".. mobname)
        Note("Casting attack spell: " .. atkspell)
      else
        Note("No primary attack spell selected.")
      end
    </send>
  </alias>

  <!-- Cast AoE Spell -->
  <alias
   match="^aam aoe$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   regexp="y"
  >
    <send>-- Get variable
	aoespell = GetVariable("aoespell")
      -- Cast the AoE spell
      if aoespell then
        Send("c '".. aoespell .."'")
        Note("Casting AoE spell: " .. aoespell)
      else
        Note("No AoE spell selected.")
      end
    </send>
  </alias>

  <!-- Set the atkspell -->
  <alias
   match="^aam set atk (.*)$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   regexp="y"
  >
    <send>atkspell = "%1"
      SetVariable("atkspell", "%1")
      Note("Set the attack spell to: " .. atkspell)
    </send>
  </alias>

  <!-- Set the aoespell -->
  <alias
   match="^aam set aoe (.*)$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   regexp="y"
  >
    <send>aoespell = "%1"
      SetVariable("aoespell", "%1")
      Note("Set the AoE spell to: " .. aoespell)
    </send>
  </alias>

<!-- Clear primary attack or AoE or skill or all -->
<alias
   match="^aam clear (patk|aoe|skill|shortsyntax|all)$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   expand_variables="y"
   regexp="y"
>
    <send>
      local target = "%1"
      if target == "patk" then
        -- Clear all primary attack spells
        Patk = {}
        SetVariable("Patk", "Patk = {}")
        Note("Cleared all primary attack spells.")
      elseif target == "aoe" then
        -- Clear all AoE spells
        Aoe = {}
        SetVariable("Aoe", "Aoe = {}")
        Note("Cleared all AoE spells.")
      elseif target == "skill" then
        -- Clear all skills
        Skills = {}
        SetVariable("Skills", "Skills = {}")
        Note("Cleared all skills.")
	  elseif target == "shortsyntax" then
	    -- Clear all Short syntax
		SkillShortSyntax = {}
		SetVariable("SkillShortSyntax", "SkillShortSyntax = {}")
		Note("Cleared all Short syntax.")
      else
        -- Clear both primary attack, AoE spells, and skills
        Patk = {}
        Aoe = {}
        Skills = {}
        SetVariable("Patk", "Patk = {}")
        SetVariable("Aoe", "Aoe = {}")
        SetVariable("Skills", "Skills = {}")
        Note("Cleared all primary attack spells, AoE spells, and skills.")
      end
    </send>
</alias>

  
  <!-- New aliases for skills -->
  
  <!-- Set the skill -->
<alias
   match="^aam set skill (.*)$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   regexp="y"
>
  <send>
    skill = "%1"
    SetVariable("skill", "%1")
    Note("Set the primary skill to: " .. skill)
  </send>
</alias>

  
  <!-- Add Skill -->
<alias
   match="^aam add skill (.*)$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   expand_variables="y"
   regexp="y"
  >
    <send>local skill = "%1"
      -- Add skill to the Skills table (case-insensitive check for existing skill)
      local found = false
      for _, v in ipairs(Skills) do
        if string.lower(v) == string.lower(skill) then
          found = true
          break
        end
      end
      if not found then
        table.insert(Skills, skill)
        Note("Added skill: " .. skill)
      else
        Note("Skill already exists in the list.")
      end
    </send>
  </alias>

<!-- Remove Skill -->
<alias
   match="^aam rem skill (.*)$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   expand_variables="y"
   regexp="y"
  >
    <send>
      local skill = "%1"
      -- Find the index of the skill in the Skills table (case-insensitive)
      local index = nil
      for i, v in ipairs(Skills) do
        if string.lower(v) == string.lower(skill) then
          index = i
          break
        end
      end
      -- Remove skill if found
      if index then
        table.remove(Skills, index)
        Note("Removed skill: " .. skill)
      else
        Note("Skill not found in the list.")
      end
    </send>
  </alias>
  
<!-- Cast Skill -->
<alias
   match="^aam skill$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   regexp="y"
>
    <send>-- Get variable
	skill = GetVariable("skill")
    -- Check if the skill has a short syntax set
    local shortSkill = SkillShortSyntax[string.lower(skill)]
    if shortSkill then
        skill = shortSkill  -- Use the short syntax
    end
    -- Cast the skill
    if skill then
        Send(skill)
        Note("Casting skill: " .. skill)
    else
        Note("No skill selected.")
    end
    </send>
</alias>


<!-- Cast Skill with Target -->

<alias
   match="^aam skill (.*)$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   regexp="y"
>
    <send>-- Get variable
	skill = GetVariable("skill")
    -- Check if the skill has a short syntax set
    local shortSkill = SkillShortSyntax[string.lower(skill)]
    if shortSkill then
        skill = shortSkill  -- Use the short syntax
    end
    local mobname = "%1"
    -- Cast the skill
    if skill then
        Send(skill .." ".. mobname)
        Note("Casting skill: " .. skill)
    else
        Note("No skill selected.")
    end
    </send>
</alias>


<!-- Set the skill short syntax -->
<alias
   match="^aam setskill (.*) to (.*)$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   regexp="y"
>
  <send>
    local skill = "%1"
    local shortSyntax = "%2"
    -- Store the short syntax for the skill
    SkillShortSyntax[string.lower(skill)] = string.lower(shortSyntax)
    Note("Set the short syntax for skill '" .. skill .. "' to: " .. shortSyntax)
  </send>
</alias>

<!-- Show the short syntax for a skill -->
<alias
   match="^aam showskill (.*)$"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   regexp="y"
>
  <send>
    local skill = "%1"
    local shortSyntax = SkillShortSyntax[string.lower(skill)]
    if shortSyntax then
        Note("The short syntax for skill '" .. skill .. "' is: " .. shortSyntax)
    else
        Note("No short syntax set for skill '" .. skill .. "'")
    end
  </send>
</alias>

<alias
 match="^aam status$"
 enabled="y"
 group="attack"
 send_to="12"
 sequence="100"
 regexp="y"
>
 <send>ShowStatus()</send>
</alias>

</aliases>

<!-- Script -->
<script>
<![CDATA[

require "serialize"

-- Initialize the tables for storing attack and AoE spells
Patk = {}
Aoe = {}
Skills = {}
SkillShortSyntax = {}

-- Function to check if a value exists in a table (case-insensitive)
function table.contains(tbl, val)
  for _, v in ipairs(tbl) do
    if string.lower(v) == string.lower(val) then
      return true
    end
  end
  return false
end

-- aam new list function
function ShowList(listType)
    local header_col = "cyan"
    local item_col = "white"
    local border_col = "mediumblue"
    local arrow_col = "yellow"
    local cmd_col = "lime"

    -- Table to help title the box
    local titles = {
        patk = "Primary Attack Spells",
        aoe  = "AoE Spells",
        skill = "Available Skills",
        shortsyntax = "Short Syntax Mappings"
    }

    -- Helper to draw the box header
    local function DrawHeader(title)
        Note("")
        ColourNote(border_col, "", "+-----------------------------------------------------------------+")
        ColourNote(border_col, "", "| ", header_col, "", string.format("%-63s", title), border_col, "", " |")
        ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    end

    -- Helper to draw a single row in the grid
    local function DrawRow(col1, col2)
        col1 = col1 or ""
        col2 = col2 or ""
        -- Two columns of 30 chars each, plus spacing = 63 internal width
        local line = string.format(" %-30s %-31s", col1, col2)
        ColourNote(border_col, "", "|", item_col, "", line, border_col, "", "|")
    end

    -- Handle specific lists
    if listType == "shortsyntax" then
        DrawHeader(titles.shortsyntax)
        local count = 0
        for skill, syntax in pairs(SkillShortSyntax) do
            count = count + 1
            local label = string.format(" %s ", skill)
            local mapping = string.format(" -> %s", syntax)
            local padding = string.rep(" ", 63 - string.len(label) - string.len(mapping))
            ColourNote(border_col, "", "|", item_col, "", label, arrow_col, "", "-> ", cmd_col, "", syntax .. padding, border_col, "", "|")
        end
        if count == 0 then DrawRow(" (No mappings defined)", "") end
    else
        -- Handle Spell/Skill Lists (Patk, Aoe, or Skills)
        local targetTable = {}
        if listType == "patk" then targetTable = Patk
        elseif listType == "aoe" then targetTable = Aoe
        elseif listType == "skill" then targetTable = Skills
        elseif listType == "all" then 
            -- If 'all', recursively call for each and exit
            ShowList("patk")
            ShowList("aoe")
            ShowList("skill")
            ShowList("shortsyntax")
            return 
        end

        DrawHeader(titles[listType] or "List")
        if #targetTable == 0 then
            DrawRow(" (List is empty)", "")
        else
            for i = 1, #targetTable, 2 do
                DrawRow(targetTable[i], targetTable[i+1])
            end
        end
    end

    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    Note("")
end

-- aam status command stuff
function ShowStatus()
    local header_col = "cyan"
    local label_col = "white"
    local val_col = "lime"
    local count_col = "yellow"
    local border_col = "mediumblue"
    
    local version = GetPluginInfo(GetPluginID(), 19) or "???"
    local v_str = "v" .. version

    local currentAtk = GetVariable("atkspell") or "None"
    local currentAoe = GetVariable("aoespell") or "None"
    local currentSkill = GetVariable("skill") or "None"
    local atkCount = tostring(#Patk or 0)
    local aoeCount = tostring(#Aoe or 0)
    local skillCount = tostring(#Skills or 0)
    local shortCount = 0
    for _ in pairs(SkillShortSyntax) do shortCount = shortCount + 1 end
    shortCount = tostring(shortCount)

    local function PrintStatusLine(label, value, value_color)
        local total_width = 63
        local label_len = string.len(label)
        local padding_len = total_width - label_len - string.len(value)
        local padding = string.rep(" ", math.max(0, padding_len))
        ColourNote(border_col, "", "| ", label_col, "", label, value_color, "", value .. padding, border_col, "", " |")
    end

    Note("")
    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    -- Header with version aligned right
    ColourNote(border_col, "", "| ", header_col, "", string.format("%-54s", "Atk_Aoe_Manager Status"), header_col, "", string.format("%9s", v_str), border_col, "", " |")
    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    
    PrintStatusLine("Active Atk: ", currentAtk, val_col)
    PrintStatusLine("Active AoE: ", currentAoe, val_col)
    PrintStatusLine("Active Skl: ", currentSkill, val_col)
    
    ColourNote(border_col, "", "|                                                                 |")
    ColourNote(border_col, "", "| ", header_col, "", string.format("%-63s", "List Statistics:"), border_col, "", " |")
    
    PrintStatusLine("Spells in Atk List   : ", atkCount, count_col)
    PrintStatusLine("Spells in AoE List   : ", aoeCount, count_col)
    PrintStatusLine("Skills in List       : ", skillCount, count_col)
    PrintStatusLine("Short Syntax Mappings: ", shortCount, count_col)
    
    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    Note("")
end

-- Help function to explain how the plugin works
function OnHelp()
    local header_col = "cyan"
    local command_col = "yellow"
    local desc_col = "white"
    local border_col = "mediumblue"
    
    local version = GetPluginInfo(GetPluginID(), 19) or "???"
    local v_str = "v" .. version

    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    -- Header with version aligned right
    ColourNote(border_col, "", "| ", header_col, "", string.format("%-54s", "Atk_Aoe_Manager Help"), header_col, "", string.format("%9s", v_str), border_col, "", " |")
    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    
    local function HelpLine(cmd, desc)
        ColourNote(command_col, "", string.format(" %-33s ", cmd), desc_col, "", "- " .. desc)
    end

    Note("")
    HelpLine("aam status", "View active spells and list counts.")
    HelpLine("aam list <all|patk|aoe|shortsyntax>", "See full contents of your lists.")
    Note("")
    ColourNote(header_col, "", "--- Management ---")
    HelpLine("aam add <patk|aoe|skill> <name>", "Add item to watch list.")
    HelpLine("aam rem <patk|aoe|skill> <name>", "Remove item from list.")
    HelpLine("aam clear <all|patk|aoe|skill>", "Wipe a list clean.")
    Note("")
    ColourNote(header_col, "", "--- Manual Control ---")
    HelpLine("aam set <atk|aoe|skill> <name>", "Force a specific spell/skill.")
    HelpLine("aam setskill <name> to <shortsyntax>", "Map long name to short command.")
    Note("")
    ColourNote(header_col, "", "--- Combat ---")
    HelpLine("aam atk [target]", "Cast attack spell.")
    HelpLine("aam skill [target]", "Use current skill.")
    HelpLine("aam aoe", "Cast AoE spell.")
    Note("")
    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
end

-- Save the stored tables and reload them on new session
function OnPluginSaveState ()
  -- Save both spellsTable and currentIndex
  SetVariable("Patk", "Patk = " .. serialize.save_simple(Patk))
  SetVariable("Aoe", "Aoe = " .. serialize.save_simple(Aoe))
  SetVariable("Skills", "Skills = " .. serialize.save_simple(Skills))
  SetVariable("SkillShortSyntax", "SkillShortSyntax = " .. serialize.save_simple(SkillShortSyntax))
end

function OnPluginInstall ()
  ColourNote("blue", "yellow", "[AAM] Installed! Type 'aam help' for commands or 'aam status' to see active spells.")
  assert(loadstring(GetVariable("Patk") or ""))()
  assert(loadstring(GetVariable("Aoe") or ""))()
  assert(loadstring(GetVariable("Skills") or ""))()
  assert(loadstring(GetVariable("SkillShortSyntax") or ""))()
end

 ----------------------- Plugin Update Code -----------------------
 -- Code taken from Durel's dinv plugin, originally via Crowley
 require("wait")
require("async")
json = require("json")

 plugin_url = "https://raw.githubusercontent.com/Khrysis-aard/plugins/refs/heads/main/Atk_Aoe_Manager.xml"
 SetVariable("DownloadURL", plugin_url)
 plugin_protocol = "HTTPS"
 plugin_prefix = "[Atk_Aoe_Manager]"
 
 function update_check_alias()
     update_plugin("check")
     ColourNote("yellow", "", plugin_prefix .. "","white",""," Checking for updated version...")
 end
 
 function update_install_alias()
     update_plugin("install")
     ColourNote("yellow", "", plugin_prefix .. "","white",""," Checking for and installing updated version...")
 end
 
 function reload_plugin()
     local scriptPrefix = GetAlphaOption("script_prefix")
     local retval
 
     -- If the user has not already specified the script prefix for this version of mush, pick a
     -- reasonable default value
     if (scriptPrefix == "") then
         scriptPrefix = "\\\\\\"
         SetAlphaOption("script_prefix", scriptPrefix)
     end
 
     -- Tell mush to reload the plugin in one second.  We can't do it directly here because a
     -- plugin can't unload itself.  Even if it could, how could it tell mush to load it again
     -- if it weren't installed? 
     retval = Execute(scriptPrefix.."DoAfterSpecial(0.1, \"ReloadPlugin('"..GetPluginID().."')\", sendto.script)")
 end
 
 function update_plugin(mode)
     update_mode = mode
 
     wait.make(get_plugin_file)
 end
 
 function get_plugin_file()
     local urlThread = async.request(plugin_url, plugin_protocol)
 
     if not urlThread then
         note_error("Couldn't create async url request.")
         return
     end
 
     local timeout = 10
     local totTime = 0
     while (urlThread:alive() and totTime < timeout) do
         wait.time(0.1)
         totTime = totTime + 0.1
     end
 
     local remoteRet, pluginData, status, headers, fullStatus = urlThread:join()
 
     if not status then
         ColourNote("red", "", plugin_prefix .. " Couldn't download plugin file. No status code.")
         
         return
     end
 
     if (status ~= 200) then
         ColourNote("red", "", plugin_prefix .. " Plugin file request status code: " .. status .. ": " .. fullStatus)
         return
     end
     
     local currentVersion = GetPluginInfo(GetPluginID(), 19) or 0
     local currentVerStr  = string.format("%1.3f", currentVersion)
     local remoteVerStr   = string.match(pluginData, '%s%s+version="([0-9%.]+)"')
     local remoteVersion  = tonumber(remoteVerStr or "") or 0
 
     if remoteVersion == currentVersion then
         ColourNote("yellow", "", plugin_prefix .. "","white",""," You are running the most recent version. (","cyan","","v" .. currentVerStr .. "","white","",")")
     elseif (remoteVersion < currentVersion) then
         ColourNote("yellow", "", plugin_prefix .. "","white",""," You have a newer version than is publicly available. (","cyan","","v" .. currentVerStr .. "","white","",")")
     elseif (update_mode == "check") then
         ColourNote("yellow", "", plugin_prefix .. "","white",""," You are running ","cyan","","v" .. currentVerStr .. "","white",""," , but there's a newer version ","cyan","","v" .. remoteVerStr)
     elseif (update_mode == "install") then
         ColourNote("yellow", "", plugin_prefix .. "","white",""," Updating plugin from version ","cyan","", currentVerStr .. "","white",""," to version ","cyan","", remoteVerStr .."") 
 
         local pluginFile = GetPluginInfo(GetPluginID(), 6)
         local file = io.open(pluginFile, "wb")
         file:write(pluginData)
         file:close()
         reload_plugin()
     else
         ColourNote("red", "", plugin_prefix .. " Invalid update mode: " .. update_mode)
     end
 end
 ----------------------- End Plugin Update Code -----------------------
]]>
</script>

</muclient>
