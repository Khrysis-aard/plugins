<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, May 24, 2025, 1:51 PM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "Potion_tracker" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Potion_tracker"
   author="Khrysis"
   id="9c1c367c95e1d469f201ed44"
   language="Lua"
   purpose="track potions and countdown remaining"
   save_state="y"
   date_written="2025-05-24 13:46:46"
   requires="5.07"
   version="1.48"
  >
</plugin>

    <aliases>
	<alias
      match="^ptw order$"
      enabled="y"
      regexp="y"
      script="ToggleDisplayOrder"
    >
    </alias>
	<alias
      match="^ptw kw list$"
      enabled="y"
      regexp="y"
      script="ListPotionKeywords"
    >
    </alias>
	<alias
      match="^ptw kw add (.+) (.+)$"
      enabled="y"
      regexp="y"
      script="SetPotionAlias"
    >
	</alias>
	<alias
      match="^ptw kw remove (.+)$"
      enabled="y"
      regexp="y"
      script="RemovePotionAlias"
    >
	</alias>
	<alias
      match="^ptw font (\d+)$"
      enabled="y"
      regexp="y"
      script="SetFontSize"
    >
    </alias>
	<!--  Aliases to turn off potion msg and untracked potion msg  -->
	<alias
      match="^ptw usage (on|off)$"
      enabled="y"
      regexp="y"
      script="ToggleUsageMessages"
    >
    </alias>
	<alias
      match="^ptw untracked (on|off)$"
      enabled="y"
      regexp="y"
      script="ToggleUntrackedMessages"
    >
    </alias>
	<alias
      match="^ptw color reset$"
      enabled="y"
      regexp="y"
      script="ResetColorThresholds"
    >
    </alias>
	<alias
      match="^ptw color (\d+) (\d+) (\d+)$"
      enabled="y"
      regexp="y"
      script="SetColorThresholds"
    >
    </alias>
	<alias
      match="^ptw set (.+) (\d+)$"
      enabled="y"
      regexp="y"
      script="SetPotionCount"
    >
    </alias>
	<alias
      match="^ptw remove (.+)$"
      enabled="y"
      script="RemoveApprovedPotion"
      regexp="y"
    >
    </alias>
	<alias
      match="^ptw list$"
      enabled="y"
      script="ListApprovedPotions"
      regexp="y"
    >
    </alias>
	<alias
      match="^ptw add (.+)$"
      enabled="y"
      script="AddApprovedPotion"
      regexp="y"
      sequence="3"
    >
    </alias>
    <alias
      match="^ptw help$"
      enabled="y"
      script="ShowHelp"
      regexp="y"
      sequence="3"
    >
	</alias>
	<alias 
      match="^ptw update check$" 
      enabled="y" 
      script="update_check_alias"
      regexp="y"	  
      sequence="99"
      >
     </alias>  
     <alias 
      match="^ptw update install$" 
      enabled="y" 
      script="update_install_alias"
      regexp="y"	  
      sequence="99"
      >
    </alias>
	<alias 
	 match="^ptw reset$"
	 enabled="y"
	 script="ResetPotions"
	 regexp="y"
	 sequence="2"
	 >
	</alias>
	
	<!--  Aliases to turn window on or off  -->
	<alias
     match="^ptw hide$"
	 enabled="y"
	 regexp="y"
	 script="hide_mw"
	 sequence="1"
    >
    </alias>
    <alias
     match="^ptw show$"
	 enabled="y"
	 regexp="y"
	 script="show_mw"
	 sequence="1"
    >
    </alias>
	
	<!--  Alias to show status  -->
	<alias
     match="^ptw status$"
     enabled="y"
     regexp="y"
     script="ShowStatus"
     >
    </alias>
	
	<!--  Alias to turn off quaff messages if approved potion  -->
	<alias
     match="^ptw quiet (on|off)$"
     enabled="y"
     regexp="y"
     script="ToggleQuietMode"
     >
    </alias>
	
	<!--  Aliases for Sync counts for potions from inventory and bag if bagid is set  -->
	<alias
      match="^ptw sync add (\d+)$"
      enabled="y"
      regexp="y"
      script="AddSyncContainer" 
      sequence="100"
    />

    <alias
      match="^ptw sync clear$"
      enabled="y"
      regexp="y"
      send_to="12"
      sequence="100"
    >
       <send>
        sync_containers = {}
        ColourNote("yellow", "", "[PTW] Sync container list cleared.")
        SaveState()
      </send>
    </alias>

    <alias
      match="^ptw sync$"
      enabled="y"
      regexp="y"
      script="DoSync"
      sequence="100"
    />
	
  </aliases>
	
	<triggers>
    <!-- Trigger for using Sync -->
	<trigger
 match="^\{ptw-start\}$"
 enabled="y"
 regexp="y"
 omit_from_output="y"
 sequence="1"
 send_to="12"
>
 <send>
    potion_inventory = {} 
    capture_sync_active = true
    EnableTrigger("potion_sync_capture", true)
 </send>
</trigger>

<trigger
 match="^\{ptw-end\}$"
 enabled="y"
 regexp="y"
 omit_from_output="y"
 sequence="1"
 script="OnSyncComplete"
/>

<trigger
 name="potion_sync_capture"
 enabled="n"
 match="*" 
 omit_from_output="y"
 script="OnSyncLine"
 sequence="5" 
/>

	<!-- Trigger for using potions -->
    <trigger
      enabled="y"
      match="^You (?:quaff|eat) (.+?)\.$"
      script="OnUsePotion"
      regexp="y"
      sequence="3"
      omit_from_output="y"
    />
	<!-- Trigger for stealing potions -->
	<trigger
      enabled="y"
      match="^You steal (\d+) \* (.+?) away from .+, saving [\d,]+ gold\.$"
      script="OnStealPotion"
      regexp="y"
      sequence="1"
    />
    <trigger
      enabled="y"
      match="^You steal (.+?) away from .+, saving [\d,]+ gold\.$"
      script="OnStealSinglePotion"
      regexp="y"
      sequence="2"
    />
	<!-- Trigger for buying potions -->
    <trigger
      enabled="y"
      match="^You buy (\d+) \* (.+?) from .+ for [\d,]+ gold\.$"
      script="OnBuyPotion"
      regexp="y"
	  sequence="1"
    />
	<trigger
      enabled="y"
      match="^You buy (.+?) from .+ for [\d,]+ gold\.$"
      script="OnBuySinglePotion"
      regexp="y"
	  sequence="2"
    />
	<!-- Triggers for receive give drop get sell-->
	<trigger
      match="^You receive (\d+) \* (.+) from .+\.$"
      script="OnReceivePotion"
      regexp="y"
      enabled="y"
	  sequence="1"
    />
    <trigger
      match="^You give (\d+) \* (.+) to .+\.$"
      script="OnGivePotion"
      regexp="y"
      enabled="y"
	  sequence="1"
    />
    <trigger
      match="^You drop (\d+) \* (.+)\.$"
      script="OnDropPotion"
      regexp="y"
      enabled="y"
	  sequence="1"
    />
    <trigger
      match="^You get (\d+) \* (.+)\.$"
      script="OnGetPotion"
      regexp="y"
      enabled="y"
	  sequence="1"
    />
    <trigger
      match="^You receive (.+?) from .+\.$"
      script="OnReceiveSinglePotion"
      regexp="y"
      enabled="y"
	  sequence="2"
    />
    <trigger
      match="^You give (.+?) to .+\.$"
      script="OnGiveSinglePotion"
      regexp="y"
      enabled="y"
	  sequence="2"
    />
    <trigger
      match="^You drop (.+?)\.$"
      script="OnDropSinglePotion"
      regexp="y"
      enabled="y"
	  sequence="2"
    />
    <trigger
      match="^You get (?![\d,]+ gold coins)(.+?)\.$"
      script="OnGetSinglePotion"
      regexp="y"
      enabled="y"
	  sequence="2"
    />
	<trigger
      enabled="y"
      match="^You sell (\d+) \* (.+?) to .+ for [\d,]+ gold\.$"
      script="OnSellPotion"
      regexp="y"
      sequence="1"
    />
    <trigger
      enabled="y"
      match="^You sell (.+?) to .+ for [\d,]+ gold\.$"
      script="OnSellSinglePotion"
      regexp="y"
      sequence="2"
    />
		<!-- Triggers for recite scrolls -->
	<trigger
      enabled="y"
      match="^You recite (.+?) on .+\.$"
      script="OnUsePotion"
      regexp="y"
      sequence="4"
    />
  </triggers>

  <script>
    <![CDATA[
	
	require "themed_miniwindows"
	require "serialize"

    local my_window = ThemedTextWindow("testpotiontrackerwindow", 200, 200, 200, 200, "Potion Tracker", "center", false, true, true, false, false, false, false, Dina, font_size, Dina, font_size, 1000, 5, true, false)
    
	hide_quaff_messages = GetVariable("hide_quaff_messages") == "true"
	show_usage_messages = GetVariable("show_usage_messages") ~= "false"
	show_untracked_messages = GetVariable("show_untracked_messages") == "true"
	approved_potions = approved_potions or {}
	potion_inventory = potion_inventory or {}
	color_thresholds = color_thresholds or { low = 4, medium = 9, high = 14 }
	potion_aliases = potion_aliases or {}
    sync_containers = sync_containers or {}
	
	  -- Hide the miniwindow
	function hide_mw()
		my_window:hide()
	end
	
	-- Show the miniwindow
	function show_mw()
		my_window:show()
	end

    function SetFontSize(name, line, wildcards)
      local new_size = tonumber(wildcards[1])
      if not new_size or new_size < 6 or new_size > 32 then
        Note("Please enter a font size between 6 and 32.")
        return
      end

      font_size = new_size
      SetVariable("font_size", tostring(font_size))

      -- Recreate the window with the new font size
      my_window = ThemedTextWindow(
        "testpotiontrackerwindow", 200, 200, 200, 200,
        "Potion Tracker", "center",
        false, true, true, false, false, false, false,
        Dina, font_size, Dina, font_size,
        1000, 5, true, false
      )

      refresh_miniwindow()
      Note("Font size set to " .. font_size)
	  my_window:show()
    end

-- New Sync Command Functions

function AddSyncContainer(name, line, wildcards)
    local id = wildcards[1]
    sync_containers = sync_containers or {}
    sync_containers[id] = true
    
    ColourTell("yellow", "", "[PTW] Added container ")
    ColourTell("cyan", "", id)
    ColourNote("yellow", "", " to sync list.")
    
    SaveState() -- This ensures the ID is saved to your variables
end

function DoSync()
    -- 1. Check for bags FIRST and warn the user BEFORE the capture starts
    if not sync_containers or next(sync_containers) == nil then
        Note("[PTW] Note: No bags set. Only syncing main inventory. Use 'ptw sync add <id>' to add bags.")
    end

    -- 2. Now initialize and start the capture
    potion_inventory = {} 
    capture_sync_active = true
    EnableTrigger("potion_sync_capture", true)
    
    -- 3. Send the start tag
    SendNoEcho("echo {ptw-start}")
    
    -- 4. Send the MUD commands
    SendNoEcho("invsort")
    
    if sync_containers and next(sync_containers) ~= nil then
        for id, _ in pairs(sync_containers) do
            SendNoEcho("invsort " .. id)
        end
    end
    
    -- 5. Close it out
    DoAfterSpecial(0.5, 'SendNoEcho("echo {ptw-end}")', 12)
end

function OnSyncLine(name, line, wildcards)
    if not capture_sync_active then return end

    local content = line:gsub("^%s+", ""):gsub("%s+$", "")
    
    -- 1. Ignore empty lines, tags, separators, and prompts (lines ending in >)
    if content == "" or content:find("{ptw-") or content:find("%-%-%-%-") or content:find(">$") then 
        return 
    end

    -- 2. Extract Count: ( 5) 
    local count = content:match("^%(%s*(%d+)%)") or 1
    
    -- 3. Clean Name: Strip count from front and Level from back
    local clean_name = content:gsub("^%(%s*%d+%)%s*", ""):gsub("%s*%(%d+%)%s*$", "")
    
    -- 4. Strip ONLY standard flags
    local flags = {"%(K%)", "%(Magic%)", "%(Glow%)", "%(Hum%)", "%(Invis%)", "%(Vis%)"}
    for _, flag in ipairs(flags) do
        clean_name = clean_name:gsub(flag .. "%s*", "")
    end
    
    -- 5. Final Normalization (using the helper function instead of .trim)
    local final_name = normalize_potion_name(clean_name)
    
    if approved_potions[final_name] then
        potion_inventory[final_name] = (potion_inventory[final_name] or 0) + tonumber(count)
    end
end

function OnSyncComplete(name, line, wildcards)
    -- Shutdown the capture immediately to prevent the prompt from leaking
    capture_sync_active = false
    EnableTrigger("potion_sync_capture", false)
    
    refresh_miniwindow()
    SaveState()
    ColourNote("cyan", "", "[PTW] Sync Complete!")
end

	
	function OnPluginSaveState()
      SetVariable("potion_inventory", "potion_inventory = " .. serialize.save_simple(potion_inventory))
      SetVariable("potion_aliases", "potion_aliases = " .. serialize.save_simple(potion_aliases))
      SetVariable("color_thresholds", "color_thresholds = " .. serialize.save_simple(color_thresholds))
      SetVariable("approved_potions", "approved_potions = " .. serialize.save_simple(approved_potions))
      SetVariable("font_size", tostring(font_size))
      SetVariable("show_untracked_messages", tostring(show_untracked_messages))
	  SetVariable("order_name_first", tostring(order_name_first))
	  SetVariable("show_usage_messages", tostring(show_usage_messages))
	  SetVariable("hide_quaff_messages", tostring(hide_quaff_messages))
	  SetVariable("sync_containers", "sync_containers = " .. serialize.save_simple(sync_containers))
    end


    function OnPluginInstall()
      ColourNote("blue", "yellow", "[Potion_tracker] Plugin Installed!")

      assert(loadstring(GetVariable("potion_inventory") or ""))()
      assert(loadstring(GetVariable("potion_aliases") or ""))()
      assert(loadstring(GetVariable("color_thresholds") or ""))()
      assert(loadstring(GetVariable("approved_potions") or ""))()
	  assert(loadstring(GetVariable("sync_containers") or ""))()
	  sync_containers = sync_containers or {}

      local saved_font_size = GetVariable("font_size")
      if saved_font_size then
        font_size = tonumber(saved_font_size)
      else
        font_size = 10
      end

      -- Load Boolean Settings (Defaults to False if nil)
        show_untracked_messages = GetVariable("show_untracked_messages") == "true"
        hide_quaff_messages     = GetVariable("hide_quaff_messages") == "true"
    
      -- Load Boolean Settings (Defaults to True if nil)
        show_usage_messages     = GetVariable("show_usage_messages") ~= "false"
        order_name_first        = GetVariable("order_name_first") ~= "false"

      my_window = ThemedTextWindow(
        "testpotiontrackerwindow", 200, 200, 200, 200,
        "Potion Tracker", "center",
        false, true, true, false, false, false, false,
        Dina, font_size, Dina, font_size,
        1000, 5, true, false
      )

      show_mw()
      refresh_miniwindow()
      ShowHelp()
    end
	
	function ToggleQuietMode(name, line, wildcards)
      hide_quaff_messages = (wildcards[1] == "on")
      SetVariable("hide_quaff_messages", tostring(hide_quaff_messages))
      Note("Potion quaff silencing is now " .. (hide_quaff_messages and "ON" or "OFF"))
    end
	
	function ToggleUsageMessages(name, line, wildcards)
      show_usage_messages = (wildcards[1] == "on")
      SetVariable("show_usage_messages", tostring(show_usage_messages))
      Note("Usage feedback messages are now " .. (show_usage_messages and "ON" or "OFF"))
    end
	
	function ToggleDisplayOrder()
      order_name_first = not order_name_first
      SetVariable("order_name_first", tostring(order_name_first))
      Note("Display order is now: " .. (order_name_first and "Potion Name First" or "Count First"))
      refresh_miniwindow()
    end

    function ToggleUntrackedMessages(name, line, wildcards)
      local mode = wildcards[1]
      show_untracked_messages = (mode == "on")
      SetVariable("show_untracked_messages", tostring(show_untracked_messages))
      Note("Untracked message display is now " .. (show_untracked_messages and "ON" or "OFF"))
    end

	function ResetColorThresholds()
      color_thresholds = { low = 4, medium = 9, high = 14 }
      SetVariable("color_thresholds", "color_thresholds = " .. serialize.save_simple(color_thresholds))
      Note("Color thresholds reset to default: low=4, medium=9, high=14")
      refresh_miniwindow()
    end

	function SetColorThresholds(name, line, wildcards)
      local low = tonumber(wildcards[1])
      local medium = tonumber(wildcards[2])
      local high = tonumber(wildcards[3])

      if not (low and medium and high) then
        Note("Invalid numbers. Usage: pt color <low> <medium> <high>")
        return
      end

      if not (low < medium and medium < high) then
        Note("Thresholds must be increasing: low < medium < high")
        return
      end

      color_thresholds.low = low
      color_thresholds.medium = medium
      color_thresholds.high = high

      SetVariable("color_thresholds", "color_thresholds = " .. serialize.save_simple(color_thresholds))
      Note(string.format("Color thresholds set to: low=%d, medium=%d, high=%d", low, medium, high))
      refresh_miniwindow()
    end

    -- Keyword functions
	
	function ListPotionKeywords()
    local header_col = "cyan"
    local name_col = "white"
    local arrow_col = "gray"
    local kw_col = "yellow"
    local border_col = "mediumblue"
    
     Note("")
     ColourNote(border_col, "", "+-----------------------------------------------------------------+")
     ColourNote(border_col, "", "| ", header_col, "", string.format("%-63s", "Potion Keyword Mappings"), border_col, "", " |")
     ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    
    local any = false
    -- Sorting helps find things faster
    local sorted_potions = {}
    for potion in pairs(potion_aliases) do table.insert(sorted_potions, potion) end
    table.sort(sorted_potions)

    for _, potion in ipairs(sorted_potions) do
        local keyword = potion_aliases[potion]
        
        -- Calculate padding manually to handle multiple colors in one line
        local name_part = string.sub(potion, 1, 35)
        local arrow_part = " => "
        local kw_part = keyword
        
        local line_len = string.len(name_part) + string.len(arrow_part) + string.len(kw_part)
        local padding = string.rep(" ", math.max(0, 63 - line_len))

        ColourNote(border_col, "", "| ", 
                   name_col, "", string.format("%-35s", name_part), 
                   arrow_col, "", arrow_part, 
                   kw_col, "", kw_part .. padding, 
                   border_col, "", " |")
        any = true
    end

    if not any then
        ColourNote(border_col, "", "| ", "gray", "", string.format("%-63s", "  (No keywords assigned)"), border_col, "", " |")
    end

    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    Note("")
end

	function SetPotionAlias(name, line, wildcards)
      local full_name = normalize_potion_name(wildcards[1])
      local alias = wildcards[2]

      if not approved_potions[full_name] then
        Note("Potion not approved: " .. full_name)
        return
      end

      potion_aliases[full_name] = alias
      SetVariable("potion_aliases", "potion_aliases = " .. serialize.save_simple(potion_aliases))
      Note("Set keyword '" .. alias .. "' for potion '" .. full_name .. "'")
      refresh_miniwindow()
    end

    function RemovePotionAlias(name, line, wildcards)
      local full_name = normalize_potion_name(wildcards[1])

      if potion_aliases[full_name] then
        potion_aliases[full_name] = nil
        SetVariable("potion_aliases", "potion_aliases = " .. serialize.save_simple(potion_aliases))
        Note("Removed keyword for potion: " .. full_name)
        refresh_miniwindow()
      else
        Note("No keyword set for: " .. full_name)
      end
    end

	function SetPotionCount(name, line, wildcards)
      local raw_name = wildcards[1]
      local count = tonumber(wildcards[2])
      local potion_name = normalize_potion_name(raw_name)

      if not approved_potions[potion_name] then
        Note("Potion '" .. potion_name .. "' is not approved. Use 'pt add " .. potion_name .. "' first.")
        return
      end

      potion_inventory[potion_name] = count
      SetVariable("potion_inventory", "potion_inventory = " .. serialize.save_simple(potion_inventory))
      Note("Set '" .. potion_name .. "' count to " .. count)
      refresh_miniwindow()
    end

	
	function AddApprovedPotion(name, line, wildcards)
      local potion = normalize_potion_name(wildcards[1])
      approved_potions[potion] = true
      SetVariable("approved_potions", "approved_potions = " .. serialize.save_simple(approved_potions))
      Note("Added '" .. potion .. "' to approved potions list.")
    end
	
	function ListApprovedPotions()
    local header_col = "cyan"
    local num_col    = "gray"
    local name_col   = "lime"
    local tag_col    = "yellow"
    local border_col = "mediumblue"
    
    Note("")
    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    ColourNote(border_col, "", "| ", header_col, "", string.format("%-63s", "Approved Potions List"), border_col, "", " |")
    ColourNote(border_col, "", "| ", "gray", "", string.format("%-63s", "  #   Status   Potion Name"), border_col, "", " |")
    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    
    local any = false
    local sorted_names = {}
    for name in pairs(approved_potions) do table.insert(sorted_names, name) end
    table.sort(sorted_names)

    for i, name in ipairs(sorted_names) do
        local has_kw = potion_aliases[name] and "[K]" or "   "
        local display_name = name
        
        -- Truncate name if it's too long to fit the row
        if string.len(display_name) > 48 then
            display_name = string.sub(display_name, 1, 45) .. "..."
        end

        -- Construct the row
        -- Format: "  1  [K]  A sparkly healing potion"
        local row_start = string.format(" %2d  ", i)
        local tag_part  = string.format("%-8s", has_kw)
        local line_text = row_start .. tag_part .. display_name
        local padding   = string.rep(" ", math.max(0, 63 - string.len(line_text)))

        ColourNote(border_col, "", "| ", 
                   num_col, "", row_start,
                   tag_col, "", tag_part,
                   name_col, "", display_name .. padding, 
                   border_col, "", " |")
        any = true
    end

    if not any then
        ColourNote(border_col, "", "| ", "gray", "", string.format("%-63s", "  (None)"), border_col, "", " |")
    end

    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    ColourNote("gray", "", "  [K] = Keyword/Shortname assigned")
    Note("")
end

	function RemoveApprovedPotion(name, line, wildcards)
      local potion = normalize_potion_name(wildcards[1])
      if approved_potions[potion] then
        approved_potions[potion] = nil
        SetVariable("approved_potions", "approved_potions = " .. serialize.save_simple(approved_potions))
        Note("Removed '" .. potion .. "' from approved list.")
      else
        Note("Potion not in approved list: " .. potion)
      end
    end

	
	function normalize_potion_name(name)
      if not name then return "" end
	  name = name:gsub("^%s*", "")       -- Trim leading space
      name = name:gsub("%s*$", "")       -- Trim trailing space
      
	  -- Only remove "A " or "An " if followed by a capital letter (simple heuristic)
      
	  if name:match("^A[n]? %u") then
        name = name:gsub("^A[n]? ", "")
      end
	  return name
    end

    -- Stealing potion functions

    function OnStealPotion(name, line, wildcards)
      local amount = tonumber(wildcards[1])
      local raw_name = wildcards[2]
      local potion_name = normalize_potion_name(raw_name)

      if not approved_potions[potion_name] then
        if show_untracked_messages then
          Note("Stole unapproved item: " .. potion_name)
        end
        return
      end

      potion_inventory[potion_name] = (potion_inventory[potion_name] or 0) + amount
      Note("Stole " .. amount .. " of " .. potion_name .. ". Total: " .. potion_inventory[potion_name])
      refresh_miniwindow()
    end

    function OnStealSinglePotion(name, line, wildcards)
      local raw_name = wildcards[1]
      local new_wildcards = { "1", raw_name }
      OnStealPotion(name, line, new_wildcards)
    end
	
	function OnBuySinglePotion(name, line, wildcards)
      local raw_name = wildcards[1]
      local potion_name = normalize_potion_name(raw_name)

      if not approved_potions[potion_name] then
        if show_untracked_messages then
          Note("Ignoring unapproved item: " .. potion_name)
        end
        return
      end

      potion_inventory[potion_name] = (potion_inventory[potion_name] or 0) + 1
      Note("Bought 1 of " .. potion_name .. ". Total: " .. potion_inventory[potion_name])
      refresh_miniwindow()
    end
	
	function OnBuyPotion(name, line, wildcards)
      local amount = tonumber(wildcards[1])
      local raw_name = wildcards[2]
      local potion_name = normalize_potion_name(raw_name)
      
	  if not approved_potions[potion_name] then
        if show_untracked_messages then
          Note("Ignoring unapproved item: " .. potion_name)
        end
        return
      end
	  
      potion_inventory[potion_name] = (potion_inventory[potion_name] or 0) + amount
      Note("Bought " .. amount .. " of " .. potion_name .. ". Total: " .. potion_inventory[potion_name])
      refresh_miniwindow()
    end

    function OnSellPotion(name, line, wildcards)
      local amount = tonumber(wildcards[1])
      local raw_name = wildcards[2]
      local potion_name = normalize_potion_name(raw_name)

      if not approved_potions[potion_name] then
        if show_untracked_messages then
          Note("Sold unapproved potion: " .. potion_name)
        end
        return
      end

      if potion_inventory[potion_name] then
        potion_inventory[potion_name] = potion_inventory[potion_name] - amount
        if potion_inventory[potion_name] <= 0 then
          potion_inventory[potion_name] = nil
          Note("Sold last of " .. potion_name .. ". Removed from inventory.")
        else
          Note("Sold " .. amount .. " of " .. potion_name .. ". Remaining: " .. potion_inventory[potion_name])
        end
        refresh_miniwindow()
      else
        Note("Sold untracked potion: " .. potion_name)
      end
    end

    function OnSellSinglePotion(name, line, wildcards)
      local raw_name = wildcards[1]
      local new_wildcards = { "1", raw_name }
      OnSellPotion(name, line, new_wildcards)
    end

	function OnUsePotion(name, line, wildcards, styles) -- added styles here
    local raw_name = wildcards[1]
    local potion_name = normalize_potion_name(raw_name)
    local is_approved = approved_potions[potion_name]

    -- HELPER FUNCTION: Uses the styles object passed directly by the trigger
    local function ReprintOriginalLine()
        -- If styles weren't passed, try to grab them from the last line info
        local styles_to_use = styles or GetTriggerInfo(GetPluginID(), name, 11) 
        
        if styles_to_use then
            for _, s in ipairs(styles_to_use) do
                ColourTell(RGBColourToName(s.textcolour), RGBColourToName(s.backcolour), s.text)
            end
            Note("") -- End the line
        else
            -- Fallback if styles aren't available
            AnsiNote(line)
        end
    end

    -- 1. IF NOT APPROVED
    if not is_approved then
        ReprintOriginalLine()
        if show_untracked_messages then
            Note("Ignoring unapproved item: " .. potion_name)
        end
        return
    end

    -- 2. IF APPROVED BUT QUIET MODE IS OFF
    if not hide_quaff_messages then
        ReprintOriginalLine()
    end

    -- 3. INVENTORY LOGIC (stays the same)
    if potion_inventory[potion_name] then
        potion_inventory[potion_name] = potion_inventory[potion_name] - 1
        local count = potion_inventory[potion_name]
        
        if show_usage_messages ~= false then
            local color = "lime"
            if count <= color_thresholds.low then color = "red"
            elseif count <= color_thresholds.medium then color = "magenta"
            elseif count <= color_thresholds.high then color = "yellow" end

            local display_name = potion_aliases[potion_name] or potion_name
            
            if count <= 0 then
                potion_inventory[potion_name] = nil
                ColourNote("white", "red", "[PTW] Used last " .. display_name .. "! Item removed.")
            else
                ColourNote("gray", "", "[PTW] ", "white", "", "Used ", color, "", display_name, "white", "", ". Remaining: ", color, "", tostring(count))
            end
        end
    end

    refresh_miniwindow()
end
	
	function OnReceivePotion(name, line, wildcards)
      local count = tonumber(wildcards[1])
      local raw_name = wildcards[2]
      local potion = normalize_potion_name(raw_name)

      if not approved_potions[potion] then
        if show_untracked_messages then
          Note("Received unapproved potion: " .. potion)
        end
        return
      end

      potion_inventory[potion] = (potion_inventory[potion] or 0) + count
      Note("Received " .. count .. " of " .. potion .. ". Total: " .. potion_inventory[potion])
      refresh_miniwindow()
    end

    function OnGivePotion(name, line, wildcards)
      local count = tonumber(wildcards[1])
      local raw_name = wildcards[2]
      local potion = normalize_potion_name(raw_name)

      if not approved_potions[potion] then
        if show_untracked_messages then
          Note("Gave unapproved potion: " .. potion)
        end
        return
      end

      if potion_inventory[potion] then
        potion_inventory[potion] = potion_inventory[potion] - count
        if potion_inventory[potion] <= 0 then
          potion_inventory[potion] = nil
          Note("Gave away last of " .. potion .. ". Removed from inventory.")
        else
          Note("Gave away " .. count .. " of " .. potion .. ". Remaining: " .. potion_inventory[potion])
        end
        refresh_miniwindow()
      else
        Note("Tried to give untracked potion: " .. potion)
      end
    end

    function OnDropPotion(name, line, wildcards)
      local amount = tonumber(wildcards[1])
      local raw_name = wildcards[2]
      local potion_name = normalize_potion_name(raw_name)

      if not approved_potions[potion_name] then
        if show_untracked_messages then
          Note("Ignoring unapproved item: " .. potion_name)
        end
        return
      end

      if potion_inventory[potion_name] then
        potion_inventory[potion_name] = potion_inventory[potion_name] - amount

        if potion_inventory[potion_name] <= 0 then
          potion_inventory[potion_name] = nil
          Note("Dropped last of " .. potion_name .. ". Removed from inventory.")
        else
          Note("Dropped " .. amount .. " of " .. potion_name .. ". Remaining: " .. potion_inventory[potion_name])
        end
      else
        Note("Dropped untracked potion: " .. potion_name)
      end

      refresh_miniwindow()
    end

    function OnGetPotion(name, line, wildcards)
      local amount = tonumber(wildcards[1])
      local raw_name = wildcards[2]
      local potion_name = normalize_potion_name(raw_name)

      if not approved_potions[potion_name] then
        if show_untracked_messages then
          Note("Ignoring unapproved item: " .. potion_name)
        end
        return
      end

      potion_inventory[potion_name] = (potion_inventory[potion_name] or 0) + amount
      Note("Picked up " .. amount .. " of " .. potion_name .. ". Total: " .. potion_inventory[potion_name])
      refresh_miniwindow()
    end
	
    function OnReceiveSinglePotion(name, line, wildcards)
      local raw_name = wildcards[1]
      local new_wildcards = { "1", raw_name }
      OnReceivePotion(name, line, new_wildcards)
    end

    function OnGiveSinglePotion(name, line, wildcards)
      local raw_name = wildcards[1]
      local new_wildcards = { "1", raw_name }
      OnGivePotion(name, line, new_wildcards)
    end

    function OnDropSinglePotion(name, line, wildcards)
      local raw_name = wildcards[1]
      local new_wildcards = { "1", raw_name }
      OnDropPotion(name, line, new_wildcards)
    end

    function OnGetSinglePotion(name, line, wildcards)
      local raw_name = wildcards[1]
      local new_wildcards = { "1", raw_name }
      OnGetPotion(name, line, new_wildcards)
    end

	function ResetPotions()
      potion_inventory = {}
      SetVariable("potion_inventory", "potion_inventory = " .. serialize.save_simple(potion_inventory))
      Note("Potion inventory reset.")
      refresh_miniwindow()
    end

	
	function refresh_miniwindow()
      my_window:clear()

      local any = false
      for potion, count in pairs(potion_inventory) do
        local color = "@G"
        local low = color_thresholds.low
        local med = color_thresholds.medium
        local high = color_thresholds.high
        local display_name = potion_aliases[potion] or potion

        if count <= low then
          color = "@R"
        elseif count <= med then
          color = "@M"
        elseif count <= high then
          color = "@Y"
        end
		
        local line_text
    if order_name_first then
      line_text = string.format("%s%s: %d\n", color, display_name, count)
    else
      line_text = string.format("%s%d: %s\n", color, count, display_name)
    end
    my_window:add_text(line_text)
        any = true
      end

      if not any then
        my_window:add_text("@WNo potions tracked.\n")
      end

      my_window:draw()
    end

    function ShowHelp()
    local header_col = "cyan"
    local command_col = "yellow"
    local desc_col = "white"
    local border_col = "mediumblue"
    local hint_col = "gray"
    
    local version = GetPluginInfo(GetPluginID(), 19) or "???"
    local v_str = "v" .. version

    Note("")
    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    ColourNote(border_col, "", "| ", header_col, "", string.format("%-54s", "Potion Tracker Help"), header_col, "", string.format("%9s", v_str), border_col, "", " |")
    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    
    local function HelpLine(cmd, desc)
        ColourNote(command_col, "", string.format(" %-24s ", cmd), desc_col, "", "- " .. desc)
    end

    Note("")
    HelpLine("ptw show | hide", "Toggle the miniwindow visibility.")
    HelpLine("ptw status", "Show current settings and thresholds.")
    HelpLine("ptw reset", "Clear all current tracked counts.")
    Note("")
    ColourNote(header_col, "", "--- Inventory Sync ---")
    HelpLine("ptw sync add <id>", "Add a bag ID to scan during sync.")
    HelpLine("ptw sync", "Scan inventory and bags for potions.")
    HelpLine("ptw sync clear", "Clear the list of tracked bags.")
    Note("")
    ColourNote(header_col, "", "--- Approved List ---")
    HelpLine("ptw add <Full Name>", "Add potion to the approved list.")
    HelpLine("ptw remove <Full Name>", "Remove potion from approved list.")
    HelpLine("ptw list", "Show all approved potion names.")
    HelpLine("ptw set <Full Name> <#>", "Manually set a potion count.")
    Note("")
    ColourNote(header_col, "", "--- Keywords (Short Names) ---")
    HelpLine("ptw kw add <Full Name> <kw>", "Assign a short keyword for window.")
    HelpLine("ptw kw remove <Full Name>", "Remove keyword for a potion.")
    HelpLine("ptw kw list", "Show all keyword assignments.")
    Note("")
    ColourNote(header_col, "", "--- Configuration & Colors ---")
    HelpLine("ptw order", "Toggle Name:Count or Count:Name.")
    HelpLine("ptw quiet <on|off>", "Silence 'You quaff...' for approved items.")
    HelpLine("ptw font <6-32>", "Change window font size.")
    HelpLine("ptw untracked <on|off>", "Toggle notices for unapproved items.")
    HelpLine("ptw usage <on|off>", "Toggle colored feedback when using.")
    HelpLine("ptw color reset", "Reset colors to 4, 9, 14.")
    HelpLine("ptw color <L> <M> <H>", "Set custom color thresholds.")
    
    -- Color Threshold Explanation
    ColourNote(hint_col, "", "      Example: 'ptw color 3 7 12' results in:")
    ColourNote(hint_col, "", "      Red: 0-3 | Mag: 4-7 | Yel: 8-12 | Grn: 13+")
    
    Note("")
    ColourNote(header_col, "", "--- Plugin Updates ---")
    HelpLine("ptw update check", "Check GitHub for a newer version.")
    HelpLine("ptw update install", "Download and install latest version.")
    Note("")
    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    Note("")
end
	
	-- Showstatus function for the alias
	
	function ShowStatus()
    local header_col = "cyan"
    local label_col = "white"
    local val_col = "lime"
    local count_col = "yellow"
    local border_col = "mediumblue"
    
    local version = GetPluginInfo(GetPluginID(), 19) or "???"
    local v_str = "v" .. version

    local approvedCount = 0
    for _ in pairs(approved_potions or {}) do approvedCount = approvedCount + 1 end
    local inventoryCount = 0
    for _ in pairs(potion_inventory or {}) do inventoryCount = inventoryCount + 1 end
    local keywordCount = 0
    for _ in pairs(potion_aliases or {}) do keywordCount = keywordCount + 1 end

    -- Logic to display Sync Container IDs
    local container_list = ""
    local cCount = 0
    for id, _ in pairs(sync_containers or {}) do 
        cCount = cCount + 1 
        container_list = container_list .. id .. " "
    end
    if container_list == "" then container_list = "(None)" end

    -- This function handles the wide spacing before the colon
    local function PrintStatusLine(label, value, value_color, prefix)
        local pre = prefix or ""
        local val_str = pre .. tostring(value)
        
        -- Label(16) + " : "(3) + Value(?) + Padding(?) = 63
        local used_space = 16 + 3 + string.len(val_str)
        local padding = string.rep(" ", math.max(0, 63 - used_space))
        
        ColourTell(border_col, "", "| ")
        ColourTell(label_col, "", string.format("%-16s", label))
        ColourTell(label_col, "", " : ")
        ColourTell(value_color, "", val_str)
        ColourTell(border_col, "", padding .. " |")
        Note("") 
    end

    Note("")
    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    ColourNote(border_col, "", "| ", header_col, "", string.format("%-53s", "Potion Tracker Status"), header_col, "", string.format("%10s", v_str), border_col, "", " |")
    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    
    -- Config
    PrintStatusLine("Font Size", font_size or 10, val_col)
    PrintStatusLine("Display Order", order_name_first and "Name First" or "Count First", val_col)
    PrintStatusLine("Quiet Mode", hide_quaff_messages and "On" or "Off", val_col)
    PrintStatusLine("Untracked Msgs", show_untracked_messages and "On" or "Off", val_col)
    PrintStatusLine("Usage Msgs", show_usage_messages and "On" or "Off", val_col)
    
    ColourNote(border_col, "", "|                                                                 |")
    ColourNote(border_col, "", "| ", header_col, "", string.format("%-63s", "Sync Settings:"), border_col, "", " |")
    
    -- New Sync Stats
    PrintStatusLine("Bags Tracked", cCount, count_col)
    PrintStatusLine("Bag IDs", container_list, val_col)

    ColourNote(border_col, "", "|                                                                 |")
    ColourNote(border_col, "", "| ", header_col, "", string.format("%-63s", "Color Thresholds:"), border_col, "", " |")
    
    -- Thresholds
    PrintStatusLine("Red (Low)", color_thresholds.low, "red", "<= ")
    PrintStatusLine("Magenta (Med)", color_thresholds.medium, "magenta", "<= ")
    PrintStatusLine("Yellow (High)", color_thresholds.high, "yellow", "<= ")
    PrintStatusLine("Green (Great)", color_thresholds.high, "lime", "> ")
    
    ColourNote(border_col, "", "|                                                                 |")
    ColourNote(border_col, "", "| ", header_col, "", string.format("%-63s", "Database Statistics:"), border_col, "", " |")
    
    -- Stats
    PrintStatusLine("Approved Potions", approvedCount, count_col)
    PrintStatusLine("Currently Owned", inventoryCount, count_col)
    PrintStatusLine("Keywords Set", keywordCount, count_col)
    
    ColourNote(border_col, "", "+-----------------------------------------------------------------+")
    Note("")
end
	
	 ----------------------- Plugin Update Code -----------------------
 -- Code taken from Durel's dinv plugin, originally via Crowley
 require("wait")
require("async")
json = require("json")

 plugin_url = "https://raw.githubusercontent.com/Khrysis-aard/plugins/refs/heads/main/Potion_tracker.xml"
 SetVariable("DownloadURL", plugin_url)
 plugin_protocol = "HTTPS"
 plugin_prefix = "[Potion_tracker]"
 
 function update_check_alias()
     update_plugin("check")
     ColourNote("yellow", "", plugin_prefix .. "","white",""," Checking for updated version...")
 end
 
 function update_install_alias()
     update_plugin("install")
     ColourNote("yellow", "", plugin_prefix .. "","white",""," Checking for and installing updated version...")
 end
 
 function reload_plugin()
     local scriptPrefix = GetAlphaOption("script_prefix")
     local retval
 
     -- If the user has not already specified the script prefix for this version of mush, pick a
     -- reasonable default value
     if (scriptPrefix == "") then
         scriptPrefix = "\\\\\\"
         SetAlphaOption("script_prefix", scriptPrefix)
     end
 
     -- Tell mush to reload the plugin in one second.  We can't do it directly here because a
     -- plugin can't unload itself.  Even if it could, how could it tell mush to load it again
     -- if it weren't installed? 
     retval = Execute(scriptPrefix.."DoAfterSpecial(0.1, \"ReloadPlugin('"..GetPluginID().."')\", sendto.script)")
 end
 
 function update_plugin(mode)
     update_mode = mode
 
     wait.make(get_plugin_file)
 end
 
 function get_plugin_file()
     local urlThread = async.request(plugin_url, plugin_protocol)
 
     if not urlThread then
         note_error("Couldn't create async url request.")
         return
     end
 
     local timeout = 10
     local totTime = 0
     while (urlThread:alive() and totTime < timeout) do
         wait.time(0.1)
         totTime = totTime + 0.1
     end
 
     local remoteRet, pluginData, status, headers, fullStatus = urlThread:join()
 
     if not status then
         ColourNote("red", "", plugin_prefix .. " Couldn't download plugin file. No status code.")
         
         return
     end
 
     if (status ~= 200) then
         ColourNote("red", "", plugin_prefix .. " Plugin file request status code: " .. status .. ": " .. fullStatus)
         return
     end
     
     local currentVersion = GetPluginInfo(GetPluginID(), 19) or 0
     local currentVerStr  = string.format("%1.3f", currentVersion)
     local remoteVerStr   = string.match(pluginData, '%s%s+version="([0-9%.]+)"')
     local remoteVersion  = tonumber(remoteVerStr or "") or 0
 
     if remoteVersion == currentVersion then
         ColourNote("yellow", "", plugin_prefix .. "","white",""," You are running the most recent version. (","cyan","","v" .. currentVerStr .. "","white","",")")
     elseif (remoteVersion < currentVersion) then
         ColourNote("yellow", "", plugin_prefix .. "","white",""," You have a newer version than is publicly available. (","cyan","","v" .. currentVerStr .. "","white","",")")
     elseif (update_mode == "check") then
         ColourNote("yellow", "", plugin_prefix .. "","white",""," You are running ","cyan","","v" .. currentVerStr .. "","white",""," , but there's a newer version ","cyan","","v" .. remoteVerStr)
     elseif (update_mode == "install") then
         ColourNote("yellow", "", plugin_prefix .. "","white",""," Updating plugin from version ","cyan","", currentVerStr .. "","white",""," to version ","cyan","", remoteVerStr .."") 
 
         local pluginFile = GetPluginInfo(GetPluginID(), 6)
         local file = io.open(pluginFile, "wb")
         file:write(pluginData)
         file:close()
         reload_plugin()
     else
         ColourNote("red", "", plugin_prefix .. " Invalid update mode: " .. update_mode)
     end
 end
 ----------------------- End Plugin Update Code -----------------------
-- ============================================================================
-- MODIFICATION LOG & NOTES
-- ============================================================================
-- If you update DINV, the "Consuming" message will return. 
-- To silence it again, search DINV for "Consuming L" and comment out this block:
--
--  MOD: Silencing the consume message to avoid spam
--  -- dbot.info("(" .. countColor .. count .. " available@W) " ..
--  --           "Consuming L" .. entry.level .. " \"@C" .. typeName .. "@W\" @Y" ..
--  --           (inv.items.getStatField(finalId, invStatFieldName) or "") .. "@W")
-- ============================================================================
    ]]>
  </script>
</muclient>
